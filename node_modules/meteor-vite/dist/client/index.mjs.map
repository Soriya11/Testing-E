{"version":3,"sources":["../../src/client/ValidateStub.ts"],"sourcesContent":["import PackageJson from '../../package.json';\nimport type { StubValidationSettings } from '../VitePluginSettings';\n\n\n/**\n * Validate that the provided stub export key maps to a working export.\n * This is quite important we do. If vite:bundler doesn't properly parse a given package, its exports will just\n * silently fail and remain undefined, without any clear warning or indication as to what's going on.\n *\n * TODO: Attempt to emit a warning directly to the server console from the client. (development environment only)\n * TODO: Import, validate, and re-export wildcard re-exports.\n * TODO: Read expected 'typeof' value from package exports at the parser and compare against the expected type\n * rather than just an undefined check.\n */\nexport function validateStub(stubbedPackage: any, { exportKeys, packageName, requestId, warnOnly }: StubValidatorOptions) {\n    console.debug('Meteor-Vite package validation:', {\n        packageName,\n        stubbedPackage,\n        exportKeys,\n        warnOnly,\n    });\n    \n    const errors: Error[] = [];\n    \n    exportKeys.forEach((key) => {\n        if (!stubbedPackage) {\n            errors.push(new ImportException(`Was not able to import Meteor package: \"${packageName}\"`, {\n                requestId: requestId,\n                packageName,\n            }))\n        }\n        if (typeof stubbedPackage[key] === 'undefined') {\n            errors.push(new UndefinedExportException(`Could not import Meteor package into the client: export '${key}' is undefined`, {\n                requestId: requestId,\n                packageName,\n                exportName: key,\n            }))\n        }\n    });\n    \n    errors.forEach((error, i) => {\n        if (warnOnly) {\n            return console.warn(error);\n        }\n        if (errors.length - 1 >= i) {\n            throw error;\n        }\n        console.error(error);\n    })\n    \n}\n\nclass MeteorViteError extends Error {\n    constructor(message: string, { packageName, requestId, exportName }: ErrorMetadata) {\n        const footerLines = [\n            `‚ö° Affected package: ${packageName}`,\n            `‚ö° Export name: { ${exportName} }`,\n            `‚ö° Vite Request ID: ${requestId}`,\n            '',\n            `‚ö†Ô∏è Open an issue - it's likely an issue with meteor-vite rather than '${packageName}'`,\n            `    ${PackageJson.bugs.url}`,\n            '',\n            `üîì  At your own risk, you can disable validation for the '${packageName}' package`,\n            `    This may allow the app to continue running, but can lead to other things breaking.`,\n            `    ${PackageJson.homepage}#stub-validation`,\n        ].join('\\n')\n        \n        super(message);\n        this.name = `[meteor-vite] ‚ö†Ô∏è ${this.constructor.name}`\n        this.stack += `\\n\\n${footerLines}`\n    }\n}\n\nclass ImportException extends MeteorViteError {}\nclass UndefinedExportException extends MeteorViteError {}\n\ntype ErrorMetadata = Pick<StubValidatorOptions, 'packageName' | 'requestId'> & { exportName?: string };\n\nexport interface StubValidatorOptions extends Pick<StubValidationSettings, 'warnOnly'>{\n    requestId: string;\n    packageName: string;\n    \n    /**\n     * Name of every export to validate for the provided stub.\n     * export {}\n     */\n    exportKeys: string[];\n}"],"mappings":";;;;;AAcO,SAAS,aAAa,gBAAqB,EAAE,YAAY,aAAa,WAAW,SAAS,GAAyB;AACtH,UAAQ,MAAM,mCAAmC;AAAA,IAC7C;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACJ,CAAC;AAED,QAAM,SAAkB,CAAC;AAEzB,aAAW,QAAQ,CAAC,QAAQ;AACxB,QAAI,CAAC,gBAAgB;AACjB,aAAO,KAAK,IAAI,gBAAgB,2CAA2C,WAAW,KAAK;AAAA,QACvF;AAAA,QACA;AAAA,MACJ,CAAC,CAAC;AAAA,IACN;AACA,QAAI,OAAO,eAAe,GAAG,MAAM,aAAa;AAC5C,aAAO,KAAK,IAAI,yBAAyB,4DAA4D,GAAG,kBAAkB;AAAA,QACtH;AAAA,QACA;AAAA,QACA,YAAY;AAAA,MAChB,CAAC,CAAC;AAAA,IACN;AAAA,EACJ,CAAC;AAED,SAAO,QAAQ,CAAC,OAAO,MAAM;AACzB,QAAI,UAAU;AACV,aAAO,QAAQ,KAAK,KAAK;AAAA,IAC7B;AACA,QAAI,OAAO,SAAS,KAAK,GAAG;AACxB,YAAM;AAAA,IACV;AACA,YAAQ,MAAM,KAAK;AAAA,EACvB,CAAC;AAEL;AAEA,IAAM,kBAAN,cAA8B,MAAM;AAAA,EAChC,YAAY,SAAiB,EAAE,aAAa,WAAW,WAAW,GAAkB;AAChF,UAAM,cAAc;AAAA,MAChB,4BAAuB,WAAW;AAAA,MAClC,yBAAoB,UAAU;AAAA,MAC9B,2BAAsB,SAAS;AAAA,MAC/B;AAAA,MACA,mFAAyE,WAAW;AAAA,MACpF,OAAO,gBAAY,KAAK,GAAG;AAAA,MAC3B;AAAA,MACA,oEAA6D,WAAW;AAAA,MACxE;AAAA,MACA,OAAO,gBAAY,QAAQ;AAAA,IAC/B,EAAE,KAAK,IAAI;AAEX,UAAM,OAAO;AACb,SAAK,OAAO,8BAAoB,KAAK,YAAY,IAAI;AACrD,SAAK,SAAS;AAAA;AAAA,EAAO,WAAW;AAAA,EACpC;AACJ;AAEA,IAAM,kBAAN,cAA8B,gBAAgB;AAAC;AAC/C,IAAM,2BAAN,cAAuC,gBAAgB;AAAC;","names":[]}